name: Deploy Demo VPS

on:
  workflow_run:
    workflows: ["Docker Image (Release)"]
    types: [completed]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Determine image tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG=$(curl -sS https://api.github.com/repos/${{ github.repository }}/releases/latest | python3 -c "import json,sys; print(json.load(sys.stdin)['tag_name'])")
          else
            TAG="${{ github.event.workflow_run.head_branch }}"
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Deploying tag: $TAG"

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy (pull + restart)
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          TAG: ${{ steps.tag.outputs.tag }}
        run: |
          IMAGE="ghcr.io/${{ github.repository }}:${TAG}"
          echo "Deploying image: $IMAGE"
          ssh -i ~/.ssh/id_ed25519 ${VPS_USER}@${VPS_HOST} "
            set -euo pipefail
            IMAGE='${IMAGE}'
            echo \"Pulling \$IMAGE...\"
            echo '${{ secrets.GHCR_TOKEN }}' | sudo podman login ghcr.io -u nash87 --password-stdin
            sudo podman pull \"\$IMAGE\"
            sudo podman tag \"\$IMAGE\" localhost/parkhub-stable:latest
            sudo systemctl restart parkhub
            echo 'Waiting for service...'
            for i in 1 2 3 4 5 6; do
              sleep 3
              if curl -sf http://127.0.0.1:7878/health > /dev/null 2>&1; then
                echo 'Health OK!'
                exit 0
              fi
              echo \"Attempt \$i: still starting...\"
            done
            echo 'Service failed to start'
            sudo journalctl -u parkhub --no-pager -n 20
            exit 1
          "
